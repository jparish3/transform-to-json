<!--
 https://github.com/stevenrskelton/transform-to-json
-->

<link rel="import" href="../polymer/polymer.html">
<link rel="import" href="../core-ajax/core-ajax.html">

<polymer-element name="transform-to-json" attributes="input json format array url">
	<template>
		<core-ajax auto url="{{url}}" handleAs="text" on-core-response="{{handleResponse}}"></core-ajax>
	</template>
	<script>
	Polymer('transform-to-json', {
		url: null,
		format: 'tsv',
		array: false,
		ready: function(){
			var text = this.textContent.trim();
			if(text.length>0) this.input = text;
		},
		handleResponse: function(e,data,obj){
			this.input = data.response;
		},
		arrayChanged: function(){ this.inputChanged(null,this.input); },
		formatChanged: function(){ this.inputChanged(null,this.input); },
		inputChanged: function(old,input){
			var data;
			if(input){
				var lines = input.trim().replace(/\r\n/g,'\n').replace(/\r/g,'\n').split('\n');

				if(typeof this.format === 'function'){
					data = lines.map(this.format);
				}else if(this.format == 'tsv'){
					if(this.array){
						data = lines.map(function(currentValue,index,array){
							return currentValue.split('\t');
						});
					}else{
						data = lines.map(function(currentValue,index,array){
							var fields = currentValue.split('\t');
							var obj = {};
							fields.forEach(function(currentValueF,indexF,arrayF){
								obj['v'+indexF] = currentValueF;
							});
							return obj;
						});
					}
				}else if(this.format == 'ssv'){
					data = lines.map(function(currentValue,index,array){
						return currentValue.split(' ').map(function(v){ return +v; });
					});
					if(!this.array){
						data = data.map(function(currentValue,index,array){
							var obj = {};
							currentValue.forEach(function(currentValueC,indexC,arrayC){
								obj['c'+indexC] = currentValueC;
							});
							return obj;
						});
					}
				}else{
					console.log('`' + this.format + '` not supported, yet.');
				}
			}
			if(this.json != data){
				this.fire('jsonchanged', data);
				this.json = data;
			}
		}
	});
	</script>
</polymer-element>